rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: 사용자가 인증되었는지 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: 사용자의 schoolId 가져오기
    function getUserSchoolId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.schoolId : null;
    }
    
    // Helper function: 문서의 schoolId와 사용자의 schoolId가 일치하는지 확인
    function isSameSchool(schoolId) {
      return isAuthenticated() && schoolId != null && getUserSchoolId() == schoolId;
    }
    
    // users 컬렉션: 사용자는 자신의 문서만 읽고 쓸 수 있음
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // schools 컬렉션: 모든 인증된 사용자가 읽을 수 있음 (검색용), 생성자는 자신의 학교만 수정 가능
    match /schools/{schoolId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // students 컬렉션: 같은 학교에 속한 사용자만 읽고 쓸 수 있음
    match /students/{studentId} {
      allow read: if isAuthenticated() && isSameSchool(resource.data.schoolId);
      allow create: if isAuthenticated() && isSameSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isSameSchool(resource.data.schoolId) && isSameSchool(request.resource.data.schoolId);
      allow delete: if isAuthenticated() && isSameSchool(resource.data.schoolId);
    }
    
    // attendance 컬렉션: 같은 학교에 속한 사용자만 읽고 쓸 수 있음
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && isSameSchool(resource.data.schoolId);
      allow create: if isAuthenticated() && isSameSchool(request.resource.data.schoolId);
      allow update: if isAuthenticated() && isSameSchool(resource.data.schoolId) && isSameSchool(request.resource.data.schoolId);
      allow delete: if isAuthenticated() && isSameSchool(resource.data.schoolId);
    }
    
    // audit_logs 컬렉션: 같은 학교에 속한 사용자만 읽을 수 있고, 모든 인증된 사용자가 작성할 수 있음
    match /audit_logs/{logId} {
      allow read: if isAuthenticated() && isSameSchool(resource.data.schoolId);
      allow create: if isAuthenticated() && isSameSchool(request.resource.data.schoolId);
      // 로그는 수정/삭제 불가
      allow update: if false;
      allow delete: if false;
    }
  }
}

